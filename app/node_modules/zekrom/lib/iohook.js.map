{"version":3,"sources":["../src/iohook.js"],"names":["_","log","IoHook","isDev","iohook","robot","player","workspace","join","usageCounter","toast","isMember","triggerList","fillIn","clipboard","cursorPosition","snippet","cursorRegex","RegExp","cursorClipboardRegex","abbreviation","cursorNext","setting","enableAbbr","enableSound","soundList","apple","__dirname","default","huaji","mobileqq","momo","pcqq","custom","tapRemove","tapResetAbbr","triggerKey","jumpNextCursor","pythonPath","Object","assign","on","keycode","keydownConfig","shiftKey","includes","String","isEmpty","triggerCursorByEditor","recordAbbr","resetAbbr","require","register","start","sync","initNpmLib","that","pkgsJson","getNpmLib","root","pkgs","targetDir","storeDir","ignoreScripts","catch","console","error","err","stack","readFileSync","JSON","parse","stringify","key","pop","keyWork","validRecordShift","validRecord","abbr","matchAbbrItem","find","isTrigger","isNil","resetCursorNext","trigger","push","content","replaceClipboard","replaceCursor","contentLines","split","contentResult","contentMax","length","getClipboard","lineNumber","contentLine","replace","recordCursorPosition","relativeCursorPosition","positions","contentLineMax","i","position","padUp","padLeft","cursorNextItem","upTime","keyTap","cursorNextItemDown","Math","abs","downTime","tap","leftTime","shift","env","name","tempFileName","label","parseContent","getContent","getClipboardJS","js","encodeURIComponent","getClipboardSH","shell","getClipboardPY","python","mode","pythonOptions","scriptPath","args","applescript","prohibitTrigger","remove","oldClipboard","compileResult","play","timeout","setTimeout","count","isFunction","isString","file","realFile","entries","files","k","v","config","undefined","abbrLen","index","relativeCursorNext"],"mappings":";;;;;;;;qjBAAA;;AAWA;;AAMA;;;AAIA;;;AApBA;;;;AAEA;;IAAYA,C;;AACZ;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AAEA;;AACA;;AACA;;;;AACA;;AACA;;;;AAEA;;AACA;;;;AAGA;;;;AAEA;;;;;;;;;;AAEA,IAAMC,MAAM,qBAAM,eAAN,CAAZ;;IAEMC,M;AACJ,oBAA2B;AAAA,QAAfC,KAAe,uEAAP,KAAO;;AAAA;;AACzB,SAAKC,MAAL,GAAc,IAAd;AACA,SAAKC,KAAL,GAAa,IAAb;AACA,SAAKC,MAAL,GAAc,yBAAO,EAAP,CAAd;AACA;AACA,SAAKC,SAAL,GAAiB,eAAKC,IAAL,CAAU,kBAAV,EAAqB,WAArB,EAAkC,UAAlC,CAAjB;AACA;AACA,SAAKC,YAAL,GAAoB,EAApB;AACA,SAAKC,KAAL,GAAa,IAAb;AACA,SAAKC,QAAL,GAAgB,KAAhB;AACA;AACA,SAAKC,WAAL,GAAmB,EAAnB;AACA;AACA,SAAKC,MAAL,GAAc;AACZC,iBAAW,MADC;AAEZC,sBAAgB,KAFJ;AAGZC,eAAS;AAHG,KAAd;AAKA,SAAKC,WAAL,GAAmB,IAAIC,MAAJ,CAAW,KAAX,EAAkB,IAAlB,CAAnB;AACA,SAAKC,oBAAL,GAA4B,IAAID,MAAJ,CAAW,MAAX,EAAmB,IAAnB,CAA5B;AACA;AACA,SAAKE,YAAL,GAAoB,EAApB;AACA,SAAKC,UAAL,GAAkB,EAAlB;AACA;AACA,SAAKC,OAAL,GAAe;AACb;AACAC,kBAAY,IAFC;AAGbC,mBAAa,CAAC,SAAD,CAHA;AAIbC,iBAAW;AACTC,eAAO,eAAKlB,IAAL,CAAUmB,SAAV,EAAqB,4BAArB,CADE;AAETC,iBAAS,eAAKpB,IAAL,CAAUmB,SAAV,EAAqB,8BAArB,CAFA;AAGTE,eAAO,eAAKrB,IAAL,CAAUmB,SAAV,EAAqB,4BAArB,CAHE;AAITG,kBAAU,eAAKtB,IAAL,CAAUmB,SAAV,EAAqB,+BAArB,CAJD;AAKTI,cAAM,eAAKvB,IAAL,CAAUmB,SAAV,EAAqB,2BAArB,CALG;AAMTK,cAAM,eAAKxB,IAAL,CAAUmB,SAAV,EAAqB,2BAArB,CANG;AAOTM,gBAAQ;AAPC,OAJE;AAab;AACAC,iBAAW,EAdE;AAeb;AACAC,oBAAc,EAhBD;AAiBb;AACAC,kBAAY,CAAC,IAAD,EAAO,IAAP,EAAa,IAAb,EAAmB,GAAnB,CAlBC;AAmBb;AACAC,sBAAgB,CAAC,IAAD,EAAO,MAAP,CApBH;AAqBbC,kBAAY;AArBC,KAAf;AAuBD;;;;+BAEUhB,O,EAAS;AAClB,WAAKA,OAAL,GAAeiB,OAAOC,MAAP,CAAc,KAAKlB,OAAnB,EAA4BA,OAA5B,CAAf;AACD;;AAED;;;;;;+BAGW;AAAA;;AACT;AACA,WAAKlB,MAAL,CAAYqC,EAAZ,CAAe,SAAf,EAA0B,yBAAiB;AAAA,YACjCC,OADiC,GACXC,aADW,CACjCD,OADiC;AAAA,YACxBE,QADwB,GACXD,aADW,CACxBC,QADwB;;AAEzC3C,YAAI,gBAAJ,EAAsByC,OAAtB,EAA+BE,QAA/B;AACA;AACA,YACE,MAAKtB,OAAL,CAAae,cAAb,CAA4BQ,QAA5B,CAAqCC,OAAOJ,OAAP,CAArC,KACA,CAAC1C,EAAE+C,OAAF,CAAU,MAAK1B,UAAf,CAFH,EAGE;AACA,iBAAO,MAAK2B,qBAAL,EAAP;AACD;AACD,cAAKC,UAAL,CAAgBP,OAAhB,EAAyBE,QAAzB;AACD,OAXD;AAYA,WAAKxC,MAAL,CAAYqC,EAAZ,CAAe,YAAf,EAA6B,YAAM;AACjC,cAAKS,SAAL;AACD,OAFD;AAGA,WAAK9C,MAAL,CAAYqC,EAAZ,CAAe,OAAf,EAAwB,gBAAiB;AAAA,YAAdC,OAAc,QAAdA,OAAc;;AACvC,YAAIA,YAAY,MAAKpB,OAAL,CAAaa,YAA7B,EAA2C;AACzC,iBAAO,MAAKe,SAAL,EAAP;AACD;AACF,OAJD;AAKD;;AAED;;;;;;gCAGY;AACV,UAAM9C,SAAS+C,QAAQ,QAAR,CAAf;AACA,WAAK/C,MAAL,GAAcA,MAAd;AACA,WAAKC,KAAL,GAAa,qBAAb;AACA,WAAK+C,QAAL;AACA,WAAKhD,MAAL,CAAYiD,KAAZ,CAAkB,KAAlB;AACA;AACA,YAAM,gBAAUC,IAAV,CACD,KAAK/C,SADJ,8CAAN;AAIA,YAAM,KAAKgD,UAAL,EAAN;AACD;;AAED;;;;;;;uCAImB;AACjB,UAAMC,OAAO,IAAb;AACA,UAAMC,WAAW,MAAM,KAAKC,SAAL,EAAvB;AACA,8DAAG;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBACK,0BAAW;AACf;AACAC,6BAASH,KAAKjD,SAFC;AAGfqD,wBAAMH,QAHS;AAIf;AACAI,kCAAcL,KAAKjD,SALJ;AAMf;AACA;AACA;AACAuD,4BAAaN,KAAKjD,SAAlB,kBATe;AAUfwD,iCAAe,IAVA,CAUK;AACpB;AAXe,iBAAX,CADL;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAAH,GAcGC,KAdH,CAcS,eAAO;AACdC,gBAAQC,KAAR,CAAcC,IAAIC,KAAlB;AACD,OAhBD;AAiBD;;AAED;;;;;;;sCAIkB;AAChB,UAAIX,WAAW,EAAf;AACA,UAAI,CAAC,qBAAYH,IAAZ,CAAoB,KAAK/C,SAAzB,oBAAL,EAA0D;AACxD,cAAM,gBAAU+C,IAAV,CACD,KAAK/C,SADJ,uOAAN;AAaD;AACDkD,iBAAW,mBAASY,YAAT,CAAyB,KAAK9D,SAA9B,oBAAX;AACA,aAAOkD,QAAP;AACD;;AAED;;;;;;mCAGe;AACb,WAAKlD,SAAL,GAAiB,IAAjB;AACD;;AAED;;;;;;;mCAIeK,W,EAAa;AAC1B,WAAKA,WAAL,GAAmB0D,KAAKC,KAAL,CAAWD,KAAKE,SAAL,CAAe5D,WAAf,CAAX,CAAnB;AACD;;AAED;;;;;;;;;+BAMW6D,G,EAAK7B,Q,EAAU;AACxB,UAAI6B,QAAQ,KAAKnD,OAAL,CAAaY,SAAzB,EAAoC;AAClC,aAAKd,YAAL,CAAkBsD,GAAlB;AACA;AACD;AACD,UAAIC,gBAAJ;AACA,UAAI/B,QAAJ,EAAc;AACZ+B,kBAAU,kBAAQC,gBAAR,CAAyBH,GAAzB,CAAV;AACD,OAFD,MAEO;AACLE,kBAAU,kBAAQE,WAAR,CAAoBJ,GAApB,CAAV;AACD;AACD,UAAMK,OAAO,KAAK1D,YAAL,CAAkBZ,IAAlB,CAAuB,EAAvB,CAAb;AACAP,UAAI,aAAJ,EAAmB6E,IAAnB;AACA,UAAI,CAAC9E,EAAE+C,OAAF,CAAU+B,IAAV,CAAL,EAAsB;AACpB,YAAMC,gBAAgB/E,EAAEgF,IAAF,CAAO,KAAKpE,WAAZ,EAAyB,CAAC,MAAD,EAASkE,IAAT,CAAzB,CAAtB;AACA7E,YAAI,kBAAJ,EAAwB8E,aAAxB;AACA;AACA,YAAI,KAAKE,SAAL,CAAeR,GAAf,KAAuB,CAACzE,EAAEkF,KAAF,CAAQH,aAAR,CAA5B,EAAoD;AAClD,eAAKI,eAAL;AACA,iBAAO,KAAKC,OAAL,CAAaL,aAAb,EAA4BN,GAA5B,CAAP;AACD;AACF;AACD;AACA,UAAI,CAACzE,EAAE+C,OAAF,CAAU4B,OAAV,CAAL,EAAyB;AACvB,aAAKvD,YAAL,CAAkBiE,IAAlB,CAAuBV,OAAvB;AACA;AACD;AACD,WAAKzB,SAAL;AACD;;AAED;;;;;;gCAGY;AACV,WAAK9B,YAAL,GAAoB,EAApB;AACD;;AAED;;;;;;sCAGkB;AAChB,WAAKC,UAAL,GAAkB,EAAlB;AACD;;AAED;;;;;;;8BAIUoD,G,EAAK;AACb,aAAO,KAAKnD,OAAL,CAAac,UAAb,CAAwBS,QAAxB,CAAiCC,OAAO2B,GAAP,CAAjC,CAAP;AACD;;;iCAEYa,O,EAAS;AACpBA,gBAAU,KAAKC,gBAAL,CAAsBD,OAAtB,CAAV;AACAA,gBAAU,KAAKE,aAAL,CAAmBF,OAAnB,CAAV;AACA,aAAOA,OAAP;AACD;;AAED;;;;;;;;qCAKiBA,O,EAAS;AACxB,UAAMG,eAAeH,QAAQI,KAAR,CAAc,IAAd,CAArB;AACA,UAAMC,gBAAgB,EAAtB;AACA,UAAMC,aAAaH,aAAaI,MAAhC;AACA,UAAMC,eAAe,kCAArB;AACA,WAAK,IAAIC,aAAa,CAAtB,EAAyBA,aAAaH,UAAtC,EAAkDG,YAAlD,EAAgE;AAC9D,YAAIC,cAAcP,aAAaM,UAAb,CAAlB;AACAC,sBAAcA,YAAYC,OAAZ,CACZ,KAAK9E,oBADO,EAEZ2E,YAFY,CAAd;AAIAH,sBAAcN,IAAd,CAAmBW,WAAnB;AACD;AACD,aAAOL,cAAcnF,IAAd,CAAmB,IAAnB,CAAP;AACD;;AAED;;;;;;;;kCAKc8E,O,EAAS;AACrB,UAAMG,eAAeH,QAAQI,KAAR,CAAc,IAAd,CAArB;AACA,UAAMC,gBAAgB,EAAtB;AACA,UAAMC,aAAaH,aAAaI,MAAhC;AACA,WAAK,IAAIE,aAAa,CAAtB,EAAyBA,aAAaH,UAAtC,EAAkDG,YAAlD,EAAgE;AAC9D,YAAIC,cAAcP,aAAaM,UAAb,CAAlB;AACAC,sBAAc,KAAKE,oBAAL,CACZF,WADY,EAEZD,UAFY,EAGZH,UAHY,CAAd;AAKAD,sBAAcN,IAAd,CAAmBW,WAAnB;AACD;AACD,WAAK3E,UAAL,GAAkBnB,OAAOiG,sBAAP,CAA8B,KAAK9E,UAAnC,CAAlB;AACA,aAAOsE,cAAcnF,IAAd,CAAmB,IAAnB,CAAP;AACD;;AAED;;;;;;;;;;yCAOqBwF,W,EAAaD,U,EAAYH,U,EAAY;AACxD,UAAMQ,YAAY,oBAAQJ,WAAR,EAAqB,KAAKnF,MAAL,CAAYE,cAAjC,CAAlB;AACA;AACAiF,oBAAcA,YAAYC,OAAZ,CAAoB,KAAKhF,WAAzB,EAAsC,EAAtC,CAAd;AACA,UAAMoF,iBAAiBL,YAAYH,MAAnC;AACA,WAAK,IAAIS,IAAI,CAAb,EAAgBA,IAAIF,UAAUP,MAA9B,EAAsCS,GAAtC,EAA2C;AACzC,YAAMC,WAAWH,UAAUE,CAAV,CAAjB;AACArG,YAAI,+BAAJ,EAAqCsG,QAArC;AACAtG,YAAI,qCAAJ,EAA2CoG,cAA3C;AACA,aAAKhF,UAAL,CAAgBgE,IAAhB,CAAqB;AACnBmB,iBAAOZ,aAAaG,UAAb,GAA0B,CADd;AAEnBU,mBACEJ,iBAAiBE,QAAjB,GAA4BD,IAAI,KAAKzF,MAAL,CAAYE,cAAZ,CAA2B8E;AAH1C,SAArB;AAKD;AACD5F,UAAI,sBAAJ,EAA4B,KAAKoB,UAAjC;AACA,aAAO2E,WAAP;AACD;;AAED;;;;;;;;;;AAiBA;;;;;4CAKwB;AACtB,UAAI,CAAChG,EAAE+C,OAAF,CAAU,KAAK1B,UAAf,CAAL,EAAiC;AAC/B,YAAMqF,iBAAiB,KAAKrF,UAAL,CAAgB,CAAhB,CAAvB;AACApB,YAAI,sBAAJ,EAA4ByG,cAA5B;AACA,YAAIA,cAAJ,EAAoB;AAClB,cAAIA,eAAeF,KAAf,GAAuB,CAA3B,EAA8B;AAC5B,iBAAK,IAAIG,SAAS,CAAlB,EAAqBA,SAASD,eAAeF,KAA7C,EAAoDG,QAApD,EAA8D;AAC5D1G,kBAAI,iBAAJ,EAAuB0G,MAAvB;AACA,mBAAKtG,KAAL,CAAWA,KAAX,CAAiBuG,MAAjB,CAAwB,IAAxB;AACD;AACF,WALD,MAKO;AACL,gBAAMC,qBAAqBC,KAAKC,GAAL,CAASL,eAAeF,KAAxB,CAA3B;AACAvG,gBAAI,uBAAJ,EAA6B4G,kBAA7B;AACA,iBAAK,IAAIG,WAAW,CAApB,EAAuBA,WAAWH,kBAAlC,EAAsDG,UAAtD,EAAkE;AAChE/G,kBAAI,mBAAJ,EAAyB+G,QAAzB;AACA,mBAAK3G,KAAL,CAAWA,KAAX,CAAiBuG,MAAjB,CAAwB,MAAxB;AACD;AACF;AACD;AACA,cAAI,0BAAJ,EAAiB;AACf,iBAAKvG,KAAL,CAAW4G,GAAX,CAAe,OAAf,EAAwB,SAAxB;AACD,WAFD,MAEO;AACL,iBAAK5G,KAAL,CAAW4G,GAAX,CAAe,OAAf,EAAwB,SAAxB;AACD;AACD,eAAK,IAAIC,WAAW,CAApB,EAAuBA,WAAWR,eAAeD,OAAjD,EAA0DS,UAA1D,EAAsE;AACpEjH,gBAAI,mBAAJ,EAAyBiH,QAAzB;AACA,iBAAK7G,KAAL,CAAWA,KAAX,CAAiBuG,MAAjB,CAAwB,MAAxB;AACD;AACF;AACD,aAAKvF,UAAL,CAAgB8F,KAAhB;AACAlH,YAAI,iBAAJ,EAAuB,KAAKoB,UAA5B;AACD;AACDpB,UAAI,uBAAJ;AACD;;;iCAEYmH,G,EAAKC,I,EAAM/B,O,EAAS;AAC/B,UAAMgC,eAAkB,KAAK/G,SAAvB,cAAyC8G,IAA/C;AACA,cAAQD,GAAR;AACE,aAAK,OAAL;AACE;AACF,aAAK,IAAL;AACE,0BAAU9D,IAAV,CACEgE,YADF,sFAEoFhC,OAFpF;AAIA;AACF,aAAK,OAAL;AACE,0BAAUhC,IAAV,CACEgE,YADF,wKAMIhC,OANJ;AASA;AACF,aAAK,QAAL;AACE,0BAAUhC,IAAV,CACEgE,YADF,EAEE,sGACEhC,OADF,GAEE,IAJJ;AAMA;AACF,aAAK,aAAL;AACE;AACF;AACErB,kBAAQhE,GAAR,CAAY,WAAZ;AA/BJ;AAiCD;;;wCAEmBmH,G,EAAKC,I,EAAM/B,O,EAASiC,K,EAAOzC,I,EAAM;AACnD,UAAIa,gBAAgB,IAApB;AACA,UAAI,+BAAgByB,QAAQ,OAAR,IAAmBA,QAAQ,aAA3C,CAAJ,EAA+D;AAC7D,eAAO,wCAAP;AACD;AACD,cAAQA,GAAR;AACE,aAAK,OAAL;AACEzB,0BAAgB,KAAK6B,YAAL,CACdlC,WAAW,KAAKmC,UAAL,CAAgBJ,IAAhB,EAAsBD,GAAtB,EAA2BG,KAA3B,EAAkCzC,IAAlC,CADG,CAAhB;AAGA;AACF,aAAK,IAAL;AACE,cAAM4C,iBAAiB,kCAAvB;AACA/B,0BAAgB,MAAM,oBAAUgC,EAAV,CACjB,KAAKpH,SADY,cACM8G,IADN,EAEpB,MAFoB,EAGpB,CAAC/C,KAAKE,SAAL,CAAeoD,mBAAmBF,cAAnB,CAAf,CAAD,CAHoB,CAAtB;AAKA;AACF,aAAK,OAAL;AACE,cAAMG,iBAAiB,kCAAvB;AACAlC,0BAAgB,MAAM,oBAAUmC,KAAV,CACjB,KAAKvH,SADY,cACM8G,IADN,EAEpB,IAFoB,EAGpB,CAAC/C,KAAKE,SAAL,CAAeoD,mBAAmBC,cAAnB,CAAf,CAAD,CAHoB,CAAtB;AAKA;AACF,aAAK,QAAL;AACE,cAAI,CAAC,sBAAD,IAAY,CAAC,qBAAYvE,IAAZ,CAAiB,KAAKhC,OAAL,CAAagB,UAA9B,CAAjB,EAA4D;AAC1DqD,4BAAgB,qDAAhB;AACA;AACD;AACD,cAAMoC,iBAAiB,kCAAvB;AACApC,0BAAgB,MAAM,oBAAUqC,MAAV,CACjB,KAAKzH,SADY,cACM8G,IADN,EAEpB;AACEY,kBAAM,MADR;AAEEC,2BAAe,CAAC,IAAD,CAFjB;AAGE5F,wBAAY,yBACR,QADQ,GAER,eAAK9B,IAAL,CAAU,KAAKc,OAAL,CAAagB,UAAvB,EAAmC,QAAnC,CALN;AAME6F,wBAAY,yBAAU,GAAV,GAAgB,IAN9B;AAOEC,kBAAM,MAAI9D,KAAKE,SAAL,CAAeoD,mBAAmBG,cAAnB,CAAf,CAAJ;AAPR,WAFoB,CAAtB;AAYA;AACF,aAAK,aAAL;AACEpC,0BAAgB,MAAM,oBAAU0C,WAAV,CACpB/C,WAAW,KAAKmC,UAAL,CAAgBJ,IAAhB,EAAsBD,GAAtB,EAA2BG,KAA3B,EAAkCzC,IAAlC,CADS,CAAtB;AAGA;AACF;AACEa,0BAAgB,KAAK6B,YAAL,CACdlC,WAAW,KAAKmC,UAAL,CAAgBJ,IAAhB,EAAsBD,GAAtB,EAA2BG,KAA3B,EAAkCzC,IAAlC,CADG,CAAhB;AA/CJ;AAmDA,aAAOa,aAAP;AACD;;AAED;;;;;;;;;kCAMcZ,a,EAAeN,G,EAAK;AAChCxE,UAAI,uBAAJ,EAA6B8E,aAA7B;AACA,UAAI,CAAC,KAAKuD,eAAL,EAAL,EAA6B;AAC3B;AACD;AAJ+B,UAKxBxD,IALwB,GAKGC,aALH,CAKxBD,IALwB;AAAA,UAKlBuC,IALkB,GAKGtC,aALH,CAKlBsC,IALkB;AAAA,UAKZD,GALY,GAKGrC,aALH,CAKZqC,GALY;AAAA,UAKPG,KALO,GAKGxC,aALH,CAKPwC,KALO;;AAMhC,WAAKgB,MAAL,CAAYzD,IAAZ,EAAkBL,GAAlB;AACA;AACA,WAAKU,eAAL;AACA,UAAMqD,eAAe,kCAArB;AACA,UAAI7C,gBAAgB,MAAM,KAAK8C,aAAL,CAAmBrB,GAAnB,EAAwBC,IAAxB,EAA8B,IAA9B,EAAoCE,KAApC,EAA2CzC,IAA3C,CAA1B;AACA,YAAM,kCAAgBa,aAAhB,CAAN;AACA,UAAI,sBAAJ,EAAa;AACX,cAAM,oCAAN;AACD,OAFD,MAEO;AACL,aAAKtF,KAAL,CAAW4G,GAAX,CAAe,GAAf,EAAoB,SAApB;AACD;AACD,UAAI,CAACjH,EAAE+C,OAAF,CAAU,KAAKzB,OAAL,CAAaE,WAAvB,CAAL,EAA0C;AACxCyC,gBAAQhE,GAAR,CAAY,KAAKqB,OAAL,CAAaG,SAAb,CAAuB,KAAKH,OAAL,CAAaE,WAApC,CAAZ;AACA,aAAKlB,MAAL,CAAYoI,IAAZ,CACE,KAAKpH,OAAL,CAAaG,SAAb,CAAuB,KAAKH,OAAL,CAAaE,WAApC,CADF,EAEE,EAAEmH,SAAS,GAAX,EAFF,EAGE,eAAO;AACL1E,kBAAQhE,GAAR,CAAYkE,GAAZ;AACD,SALH;AAOD;AACDyE,iBAAW,YAAM;AACf,0CAAgBJ,YAAhB;AACD,OAFD,EAEG,GAFH;AAGA,WAAKxF,qBAAL;AACA,WAAKE,SAAL;AACD;;;8BAESvC,Q,EAAU;AAClB,WAAKA,QAAL,GAAgBA,QAAhB;AACD;;;oCAEekI,K,EAAO;AACrB,WAAKpI,YAAL,GAAoBoI,KAApB;AACD;;;6BAEQnI,K,EAAO;AACd,WAAKA,KAAL,GAAaA,KAAb;AACD;;;sCAEiB;AAChB,UAAI,CAAC,KAAKY,OAAL,CAAaC,UAAlB,EAA8B;AAC5B,eAAO,KAAP;AACD;AACD,UAAI,KAAKZ,QAAT,EAAmB;AACjB,eAAO,IAAP;AACD;AACD,UAAI,KAAKF,YAAL,GAAoB,CAAxB,EAA2B;AACzB,aAAKA,YAAL,GAAoB,KAAKA,YAAL,GAAoB,CAAxC;AACA,YAAIT,EAAE8I,UAAF,CAAa,KAAKpI,KAAlB,CAAJ,EAA8B;AAC5B,eAAKA,KAAL,CAAW,KAAKD,YAAhB;AACD;AACD,eAAO,IAAP;AACD;AACD,UAAIT,EAAE8I,UAAF,CAAa,KAAKpI,KAAlB,CAAJ,EAA8B;AAC5B,aAAKA,KAAL,CAAW,KAAKD,YAAhB;AACD;AACD,aAAO,KAAP;AACD;;;+BAEU4G,I,EAAMD,G,EAAKG,K,EAAOzC,I,EAAM;AACjC,UAAI9E,EAAE+I,QAAF,CAAW1B,IAAX,CAAJ,EAAsB;AACpB,YAAM2B,OAAO3B,KAAK3B,KAAL,CAAW,GAAX,CAAb;AACA,YAAMuD,WAAW,mBAAS5E,YAAT,CACZ,KAAK9D,SADO,iBACcyI,KAAK,CAAL,CADd,WAAjB;AAGA,YAAIC,QAAJ,EAAc;AAAA;AAAA;AAAA;;AAAA;AACZ,iCAAmB1G,OAAO2G,OAAP,CAAeD,SAASE,KAAxB,CAAnB,8HAAmD;AAAA;AAAA,kBAAzCC,CAAyC;AAAA,kBAAtCC,CAAsC;;AACjD,kBAAMC,SAAS,sBAAY/E,KAAZ,CAAkB6E,CAAlB,CAAf;AACA,kBACEE,OAAOlC,GAAP,MAAgBA,OAAOmC,SAAvB,KACAD,OAAOxE,IAAP,MAAiBA,QAAQyE,SAAzB,CADA,IAEAD,OAAO/B,KAAP,MAAkBA,SAASgC,SAA3B,CAHF,EAIE;AACA,uBAAOF,EAAE/D,OAAT;AACD;AACF;AAVW;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAWb;AACF;AACF;;AAED;;;;;;;;2BAKOR,I,EAAML,G,EAAK;AAChB,UAAI+E,UAAU1E,KAAKY,KAAL,CAAW,EAAX,CAAd;AACA,WAAK,IAAI+D,QAAQ,CAAjB,EAAoBA,QAAQD,QAAQ3D,MAApC,EAA4C4D,OAA5C,EAAqD;AACnD,aAAKpJ,KAAL,CAAWA,KAAX,CAAiBuG,MAAjB,CAAwB,WAAxB;AACD;AACD;AACA,UAAI,KAAKtF,OAAL,CAAac,UAAb,CAAwBS,QAAxB,CAAiCC,OAAO2B,GAAP,CAAjC,CAAJ,EAAmD;AACjD,aAAKpE,KAAL,CAAWA,KAAX,CAAiBuG,MAAjB,CAAwB,WAAxB;AACD;AACF;;;2CA/P6BvF,U,EAAY;AACxC,UAAMqI,qBAAqB,EAA3B;AACAA,yBAAmBrE,IAAnB,CAAwBhE,WAAW,CAAX,CAAxB;AACA,WAAK,IAAIiF,IAAI,CAAb,EAAgBA,IAAIjF,WAAWwE,MAA/B,EAAuCS,GAAvC,EAA4C;AAC1CoD,2BAAmBrE,IAAnB,CAAwB;AACtBmB,iBAAOnF,WAAWiF,CAAX,EAAcE,KAAd,GAAsBnF,WAAWiF,IAAI,CAAf,EAAkBE,KADzB;AAEtBC,mBAASpF,WAAWiF,CAAX,EAAcG;AAFD,SAAxB;AAID;AACD,aAAOiD,kBAAP;AACD;;;;;;kBAwPYxJ,M","file":"iohook.js","sourcesContent":["// basic\nimport path from \"path\";\n\nimport * as _ from \"lodash\";\nimport { homedir } from \"os\";\nimport jsonFile from \"jsonfile\";\nimport writeFile from \"write\";\nimport npminstall from \"npminstall\";\nimport co from \"co\";\nimport isPathExist from \"path-exists\";\nimport player from \"play-sound\";\n// cpt\nimport { applescriptCopy, applescriptPaste } from \"./applescript\";\nimport { isMac, isWindows } from \"./platform\";\nimport robotJs from \"./robot\";\nimport { getFromClipboard } from \"./clipboard\";\nimport runScript from \"./runScript\";\n// util\nimport { indexes } from \"./utils\";\nimport queryString from \"query-string\";\n\n// constant\nimport keycode from \"./keycode\";\n\nimport debug from \"debug\";\n\nconst log = debug(\"zekrom:Iohook\");\n\nclass IoHook {\n  constructor(isDev = false) {\n    this.iohook = null;\n    this.robot = null;\n    this.player = player({});\n    // 工作区\n    this.workspace = path.join(homedir(), \"Documents\", \"OnceWork\");\n    // 会员设置\n    this.usageCounter = 20;\n    this.toast = null;\n    this.isMember = false;\n    // 关键触发列表\n    this.triggerList = [];\n    // 替换类型\n    this.fillIn = {\n      clipboard: \"%cv%\",\n      cursorPosition: \"%c%\",\n      snippet: \"%s:%\"\n    };\n    this.cursorRegex = new RegExp(\"%c%\", \"gi\");\n    this.cursorClipboardRegex = new RegExp(\"%cv%\", \"gi\");\n    // 临时状态\n    this.abbreviation = [];\n    this.cursorNext = [];\n    // 配置\n    this.setting = {\n      // 是否启动功能\n      enableAbbr: true,\n      enableSound: [\"default\"],\n      soundList: {\n        apple: path.join(__dirname, \"../assets/audios/apple.mp3\"),\n        default: path.join(__dirname, \"../assets/audios/default.mp3\"),\n        huaji: path.join(__dirname, \"../assets/audios/huaji.mp3\"),\n        mobileqq: path.join(__dirname, \"../assets/audios/mobileqq.mp3\"),\n        momo: path.join(__dirname, \"../assets/audios/momo.mp3\"),\n        pcqq: path.join(__dirname, \"../assets/audios/pcqq.mp3\"),\n        custom: \"\"\n      },\n      // 默认删除撤除: 14: 'backspace'\n      tapRemove: 14,\n      // 重置当前的Abbr: 29: 'ctrl\n      tapResetAbbr: 29,\n      // 触发键盘: 57: 'space', 28: 'enter', 96: 'r enter', 15: 'tab', 1: 'esc',\n      triggerKey: [\"57\", \"96\", \"15\", \"1\"],\n      // 触发下一级: 56: 'alt', 3640: ''\n      jumpNextCursor: [\"56\", \"3640\"],\n      pythonPath: \"C:\\\\Python27\"\n    };\n  }\n\n  setSetting(setting) {\n    this.setting = Object.assign(this.setting, setting);\n  }\n\n  /**\n   * 注册监听\n   */\n  register() {\n    // 记录并清除\n    this.iohook.on(\"keydown\", keydownConfig => {\n      const { keycode, shiftKey } = keydownConfig;\n      log(\"curr keycode: \", keycode, shiftKey);\n      // 跳转下一个 %c%\n      if (\n        this.setting.jumpNextCursor.includes(String(keycode)) &&\n        !_.isEmpty(this.cursorNext)\n      ) {\n        return this.triggerCursorByEditor();\n      }\n      this.recordAbbr(keycode, shiftKey);\n    });\n    this.iohook.on(\"mouseclick\", () => {\n      this.resetAbbr();\n    });\n    this.iohook.on(\"keyup\", ({ keycode }) => {\n      if (keycode === this.setting.tapResetAbbr) {\n        return this.resetAbbr();\n      }\n    });\n  }\n\n  /**\n   * 启动监听\n   */\n  async run() {\n    const iohook = require(\"iohook\");\n    this.iohook = iohook;\n    this.robot = new robotJs();\n    this.register();\n    this.iohook.start(false);\n    // 支持 babel-node\n    await writeFile.sync(\n      `${this.workspace}/.babelrc`,\n      `{\"presets\": [\"es2015\"]}`\n    );\n    await this.initNpmLib();\n  }\n\n  /**\n   * 初始化npm\n   * @returns {Promise<void>}\n   */\n  async initNpmLib() {\n    const that = this;\n    const pkgsJson = await this.getNpmLib();\n    co(function*() {\n      yield npminstall({\n        // install root dir\n        root: `${that.workspace}`,\n        pkgs: pkgsJson,\n        // install to specific directory, default to root\n        targetDir: `${that.workspace}`,\n        // link bin to specific directory (for global install)\n        // binDir: '/home/admin/.global/bin',\n        // debug: false,\n        storeDir: `${that.workspace}/node_modules`,\n        ignoreScripts: true // ignore pre/post install scripts, default is `false`\n        // forbiddenLicenses: forbit install packages which used these licenses\n      });\n    }).catch(err => {\n      console.error(err.stack);\n    });\n  }\n\n  /**\n   * 获取npm列表\n   * @returns {Promise<*|Array>}\n   */\n  async getNpmLib() {\n    let pkgsJson = [];\n    if (!isPathExist.sync(`${this.workspace}/npm.libs.json`)) {\n      await writeFile.sync(\n        `${this.workspace}/npm.libs.json`,\n        `\n      [{\n          \"name\": \"babel-node\",\n          \"version\": \"^6.5.3\"\n        },\n        {\n          \"name\": \"babel-preset-es2015\",\n          \"version\": \"^6.24.1\"\n        }\n      ]`\n      );\n    }\n    pkgsJson = jsonFile.readFileSync(`${this.workspace}/npm.libs.json`);\n    return pkgsJson;\n  }\n\n  /**\n   * 清空workspace\n   */\n  setWorkspace() {\n    this.workspace = null;\n  }\n\n  /**\n   * 注入触发列表\n   * @param triggerList\n   */\n  setTriggerList(triggerList) {\n    this.triggerList = JSON.parse(JSON.stringify(triggerList));\n  }\n\n  /**\n   * 记录监听按键\n   * @param key\n   * @param shiftKey\n   * @returns {Promise<undefined|void>}\n   */\n  recordAbbr(key, shiftKey) {\n    if (key === this.setting.tapRemove) {\n      this.abbreviation.pop();\n      return;\n    }\n    let keyWork;\n    if (shiftKey) {\n      keyWork = keycode.validRecordShift[key];\n    } else {\n      keyWork = keycode.validRecord[key];\n    }\n    const abbr = this.abbreviation.join(\"\");\n    log(\"curr abbr: \", abbr);\n    if (!_.isEmpty(abbr)) {\n      const matchAbbrItem = _.find(this.triggerList, [\"abbr\", abbr]);\n      log(\"curr matchAbbr: \", matchAbbrItem);\n      // check is\n      if (this.isTrigger(key) && !_.isNil(matchAbbrItem)) {\n        this.resetCursorNext();\n        return this.trigger(matchAbbrItem, key);\n      }\n    }\n    // record to abbr\n    if (!_.isEmpty(keyWork)) {\n      this.abbreviation.push(keyWork);\n      return;\n    }\n    this.resetAbbr();\n  }\n\n  /**\n   * 重置记录监听结果集\n   */\n  resetAbbr() {\n    this.abbreviation = [];\n  }\n\n  /**\n   * 重置记录 %c% 相对位置\n   */\n  resetCursorNext() {\n    this.cursorNext = [];\n  }\n\n  /**\n   * 是否为有效的监听值\n   * @param {*} key\n   */\n  isTrigger(key) {\n    return this.setting.triggerKey.includes(String(key));\n  }\n\n  parseContent(content) {\n    content = this.replaceClipboard(content);\n    content = this.replaceCursor(content);\n    return content;\n  }\n\n  /**\n   * 思路:\n   * 1. 替换文本中的 % cv %\n   * @param {*} content\n   */\n  replaceClipboard(content) {\n    const contentLines = content.split(\"\\n\");\n    const contentResult = [];\n    const contentMax = contentLines.length;\n    const getClipboard = getFromClipboard();\n    for (let lineNumber = 0; lineNumber < contentMax; lineNumber++) {\n      let contentLine = contentLines[lineNumber];\n      contentLine = contentLine.replace(\n        this.cursorClipboardRegex,\n        getClipboard\n      );\n      contentResult.push(contentLine);\n    }\n    return contentResult.join(\"\\n\");\n  }\n\n  /**\n   * 思路:\n   * 1.替换文本中的 %c%\n   * @param {*} content 处理的文本\n   */\n  replaceCursor(content) {\n    const contentLines = content.split(\"\\n\");\n    const contentResult = [];\n    const contentMax = contentLines.length;\n    for (let lineNumber = 0; lineNumber < contentMax; lineNumber++) {\n      let contentLine = contentLines[lineNumber];\n      contentLine = this.recordCursorPosition(\n        contentLine,\n        lineNumber,\n        contentMax\n      );\n      contentResult.push(contentLine);\n    }\n    this.cursorNext = IoHook.relativeCursorPosition(this.cursorNext);\n    return contentResult.join(\"\\n\");\n  }\n\n  /**\n   * 思路:\n   * 1.初始记录当前标记 %c% 的位置\n   * @param {*} contentLine\n   * @param {*} lineNumber\n   * @param {*} contentMax\n   */\n  recordCursorPosition(contentLine, lineNumber, contentMax) {\n    const positions = indexes(contentLine, this.fillIn.cursorPosition);\n    // remove out the flag and figure out the pad length\n    contentLine = contentLine.replace(this.cursorRegex, \"\");\n    const contentLineMax = contentLine.length;\n    for (let i = 0; i < positions.length; i++) {\n      const position = positions[i];\n      log(\"recordCursorPosition position\", position);\n      log(\"recordCursorPosition contentLineMax\", contentLineMax);\n      this.cursorNext.push({\n        padUp: contentMax - lineNumber - 1,\n        padLeft:\n          contentLineMax - position + i * this.fillIn.cursorPosition.length\n      });\n    }\n    log(\"recordCursorPosition\", this.cursorNext);\n    return contentLine;\n  }\n\n  /**\n   * 思路:\n   * 1.计算出最近途径的 %c% 的位置\n   * @param {*} cursorNext\n   */\n  static relativeCursorPosition(cursorNext) {\n    const relativeCursorNext = [];\n    relativeCursorNext.push(cursorNext[0]);\n    for (let i = 1; i < cursorNext.length; i++) {\n      relativeCursorNext.push({\n        padUp: cursorNext[i].padUp - cursorNext[i - 1].padUp,\n        padLeft: cursorNext[i].padLeft\n      });\n    }\n    return relativeCursorNext;\n  }\n\n  /**\n   * 思路:\n   * 1.触发跳转到指定的 %c% 的下一个位置\n   * 2.默认只支持在常用的编辑器中\n   */\n  triggerCursorByEditor() {\n    if (!_.isEmpty(this.cursorNext)) {\n      const cursorNextItem = this.cursorNext[0];\n      log(\"Begin cursorNextItem\", cursorNextItem);\n      if (cursorNextItem) {\n        if (cursorNextItem.padUp > 0) {\n          for (let upTime = 0; upTime < cursorNextItem.padUp; upTime++) {\n            log(\"Begin keyTap Up\", upTime);\n            this.robot.robot.keyTap(\"up\");\n          }\n        } else {\n          const cursorNextItemDown = Math.abs(cursorNextItem.padUp);\n          log(\"Begin keyTap Down Max\", cursorNextItemDown);\n          for (let downTime = 0; downTime < cursorNextItemDown; downTime++) {\n            log(\"Begin keyTap Down\", downTime);\n            this.robot.robot.keyTap(\"down\");\n          }\n        }\n        // to trigger end of line\n        if (isWindows()) {\n          this.robot.tap(\"RIGHT\", \"CONTROL\");\n        } else {\n          this.robot.tap(\"RIGHT\", \"COMMAND\");\n        }\n        for (let leftTime = 0; leftTime < cursorNextItem.padLeft; leftTime++) {\n          log(\"Begin keyTap Left\", leftTime);\n          this.robot.robot.keyTap(\"left\");\n        }\n      }\n      this.cursorNext.shift();\n      log(\"Rest cursorNext\", this.cursorNext);\n    }\n    log(\"this.cursorNext empty\");\n  }\n\n  abbrFileSync(env, name, content) {\n    const tempFileName = `${this.workspace}/abbr.${name}`;\n    switch (env) {\n      case \"plain\":\n        break;\n      case \"js\":\n        writeFile.sync(\n          tempFileName,\n          `var oncework = {}; oncework.clipboard = decodeURIComponent(process.argv[2]);\\n ${content}`\n        );\n        break;\n      case \"shell\":\n        writeFile.sync(\n          tempFileName,\n          `\n          #!/bin/sh\n          alias decode='node -e \"console.log(decodeURIComponent(process.argv[1]))\"'\n          onceworkClipboard=\\`decode $1\\`\n          ${content}\n          `\n        );\n        break;\n      case \"python\":\n        writeFile.sync(\n          tempFileName,\n          \"\\nimport sys\\nfrom urlparse import unquote\\nclass oncework:\\n  clipboard = unquote(sys.argv[1])\\n\" +\n            content +\n            \"\\n\"\n        );\n        break;\n      case \"applescript\":\n        break;\n      default:\n        console.log(\"not match\");\n    }\n  }\n\n  async compileResult(env, name, content, label, abbr) {\n    let contentResult = null;\n    if (isWindows() && (env === \"shell\" || env === \"applescript\")) {\n      return \"cannot support this feature in windows\";\n    }\n    switch (env) {\n      case \"plain\":\n        contentResult = this.parseContent(\n          content || this.getContent(name, env, label, abbr)\n        );\n        break;\n      case \"js\":\n        const getClipboardJS = getFromClipboard();\n        contentResult = await runScript.js(\n          `${this.workspace}/abbr.${name}`,\n          \"node\",\n          [JSON.stringify(encodeURIComponent(getClipboardJS))]\n        );\n        break;\n      case \"shell\":\n        const getClipboardSH = getFromClipboard();\n        contentResult = await runScript.shell(\n          `${this.workspace}/abbr.${name}`,\n          \"sh\",\n          [JSON.stringify(encodeURIComponent(getClipboardSH))]\n        );\n        break;\n      case \"python\":\n        if (!isMac() && !isPathExist.sync(this.setting.pythonPath)) {\n          contentResult = \"Please set python path to oncework software config.\";\n          break;\n        }\n        const getClipboardPY = getFromClipboard();\n        contentResult = await runScript.python(\n          `${this.workspace}/abbr.${name}`,\n          {\n            mode: \"text\",\n            pythonOptions: [\"-u\"],\n            pythonPath: isMac()\n              ? \"python\"\n              : path.join(this.setting.pythonPath, \"python\"),\n            scriptPath: isMac() ? \"/\" : null,\n            args: [`${JSON.stringify(encodeURIComponent(getClipboardPY))}`]\n          }\n        );\n        break;\n      case \"applescript\":\n        contentResult = await runScript.applescript(\n          content || this.getContent(name, env, label, abbr)\n        );\n        break;\n      default:\n        contentResult = this.parseContent(\n          content || this.getContent(name, env, label, abbr)\n        );\n    }\n    return contentResult;\n  }\n\n  /**\n   * 思路:\n   * 1.粘贴出指定的文本\n   * @param {*} matchAbbrItem\n   * @param {*} key\n   */\n  async trigger(matchAbbrItem, key) {\n    log(\"trigger matchAbbrItem\", matchAbbrItem);\n    if (!this.prohibitTrigger()) {\n      return;\n    }\n    const { abbr, name, env, label } = matchAbbrItem;\n    this.remove(abbr, key);\n    // 重置下一次的跳转\n    this.resetCursorNext();\n    const oldClipboard = getFromClipboard();\n    let contentResult = await this.compileResult(env, name, null, label, abbr);\n    await applescriptCopy(contentResult);\n    if (isMac()) {\n      await applescriptPaste();\n    } else {\n      this.robot.tap(\"V\", \"CONTROL\");\n    }\n    if (!_.isEmpty(this.setting.enableSound)) {\n      console.log(this.setting.soundList[this.setting.enableSound]);\n      this.player.play(\n        this.setting.soundList[this.setting.enableSound],\n        { timeout: 300 },\n        err => {\n          console.log(err);\n        }\n      );\n    }\n    setTimeout(() => {\n      applescriptCopy(oldClipboard);\n    }, 500);\n    this.triggerCursorByEditor();\n    this.resetAbbr();\n  }\n\n  setMember(isMember) {\n    this.isMember = isMember;\n  }\n\n  setUsageCounter(count) {\n    this.usageCounter = count;\n  }\n\n  setToast(toast) {\n    this.toast = toast;\n  }\n\n  prohibitTrigger() {\n    if (!this.setting.enableAbbr) {\n      return false;\n    }\n    if (this.isMember) {\n      return true;\n    }\n    if (this.usageCounter > 0) {\n      this.usageCounter = this.usageCounter - 1;\n      if (_.isFunction(this.toast)) {\n        this.toast(this.usageCounter);\n      }\n      return true;\n    }\n    if (_.isFunction(this.toast)) {\n      this.toast(this.usageCounter);\n    }\n    return false;\n  }\n\n  getContent(name, env, label, abbr) {\n    if (_.isString(name)) {\n      const file = name.split(\"_\");\n      const realFile = jsonFile.readFileSync(\n        `${this.workspace}/snippet.${file[0]}.json`\n      );\n      if (realFile) {\n        for (let [k, v] of Object.entries(realFile.files)) {\n          const config = queryString.parse(k);\n          if (\n            config.env === (env || undefined) &&\n            config.abbr === (abbr || undefined) &&\n            config.label === (label || undefined)\n          ) {\n            return v.content;\n          }\n        }\n      }\n    }\n  }\n\n  /**\n   * 因为触发功能是会产生多余的键, 需要删除\n   * @param abbr\n   * @param key\n   */\n  remove(abbr, key) {\n    let abbrLen = abbr.split(\"\");\n    for (let index = 0; index < abbrLen.length; index++) {\n      this.robot.robot.keyTap(\"backspace\");\n    }\n    // avoid space and tap trigger\n    if (this.setting.triggerKey.includes(String(key))) {\n      this.robot.robot.keyTap(\"backspace\");\n    }\n  }\n}\n\nexport default IoHook;\n"]}